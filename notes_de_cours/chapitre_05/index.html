
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://francois-mercier.github.io/cours-db1/notes_de_cours/chapitre_05/">
      
      
        <link rel="prev" href="../chapitre_04/">
      
      
        <link rel="next" href="../../exercices/exercice_01/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.1">
    
    
      
        <title>Chapitre 5 - Cours Bases de donn&eacute;es 1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.45e1311d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#base-de-donnees-1" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../.." title="Cours Bases de donn&amp;eacute;es 1" class="md-header__button md-logo" aria-label="Cours Bases de donn&eacute;es 1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M448 80v48c0 44.2-100.3 80-224 80S0 172.2 0 128V80C0 35.8 100.3 0 224 0s224 35.8 224 80zm-54.8 134.7c20.8-7.4 39.9-16.9 54.8-28.6V288c0 44.2-100.3 80-224 80S0 332.2 0 288V186.1c14.9 11.8 34 21.2 54.8 28.6C99.7 230.7 159.5 240 224 240s124.3-9.3 169.2-25.3zM0 346.1c14.9 11.8 34 21.2 54.8 28.6C99.7 390.7 159.5 400 224 400s124.3-9.3 169.2-25.3c20.8-7.4 39.9-16.9 54.8-28.6V432c0 44.2-100.3 80-224 80S0 476.2 0 432v-85.9z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cours Bases de donn&eacute;es 1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapitre 5
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="orange"  aria-label="Passer en mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer en mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="orange"  aria-label="Passer en mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer en mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/francois-mercier/cours-db1" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Onglets" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Accueil

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../chapitre_01/" class="md-tabs__link">
          
  
  Notes de cours

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../exercices/exercice_01/" class="md-tabs__link">
          
  
  Exercices

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Cours Bases de donn&amp;eacute;es 1" class="md-nav__button md-logo" aria-label="Cours Bases de donn&eacute;es 1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M448 80v48c0 44.2-100.3 80-224 80S0 172.2 0 128V80C0 35.8 100.3 0 224 0s224 35.8 224 80zm-54.8 134.7c20.8-7.4 39.9-16.9 54.8-28.6V288c0 44.2-100.3 80-224 80S0 332.2 0 288V186.1c14.9 11.8 34 21.2 54.8 28.6C99.7 230.7 159.5 240 224 240s124.3-9.3 169.2-25.3zM0 346.1c14.9 11.8 34 21.2 54.8 28.6C99.7 390.7 159.5 400 224 400s124.3-9.3 169.2-25.3c20.8-7.4 39.9-16.9 54.8-28.6V432c0 44.2-100.3 80-224 80S0 476.2 0 432v-85.9z"/></svg>

    </a>
    Cours Bases de donn&eacute;es 1
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/francois-mercier/cours-db1" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accueil
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Notes de cours
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Notes de cours
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapitre 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapitre 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_03/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapitre 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_04/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapitre 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Chapitre 5
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Exercices
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Exercices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Exercices réguliers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Exercices réguliers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../exercices/exercice_01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exercice 01 - Test123
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Exercices bonus
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Exercices bonus
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../exercices/bonus/bonus_01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus 01 - Test123
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<style>
  section {
    font-family: 'Trebuchet ms', serif !important;
    height: 720px;
    width: 1080px;
    padding: 70px 80px 70px 80px;
  }
  h1 {
    margin : 0.5em 0 1em 0;
    color: #780006;
    font-size : 40pt;
    position: absolute;
    top: 70px;
  }
  p, h2 {
    color: #333
    font-size: 24pt;
  }
  img[alt~="center"] {
    display: block;
    margin: 20px auto;
  }
  blockquote {
    border-left: 8px solid #333; 
    border-right: 8px solid #333;
    text-align: center; 
  }


  section::after {
    content: attr(data-marpit-pagination) ' / ' attr(data-marpit-pagination-total);
    color : #000;
    bottom: -2px;
  }


</style>
<!-- _paginate: false -->

<h1 id="base-de-donnees-1">Base de données 1</h1>
<p><strong>Chapitre 5 - Automatisation des traitements et procédures stockées</strong></p>
<p>Base de données 1
420-2B4-VI
Hiver 2022
Durée approximative : 30 heures — 15 périodes </p>
<hr />
<h1 id="contenu">Contenu</h1>
<ol>
<li><a href="#3">Coder avec MySQL</a></li>
<li><a href="#30">Déclencheurs</a></li>
<li><a href="#45">Lire la documentation</a></li>
<li><a href="#46">Procédures stockées, transactions et gestions des erreurs</a></li>
<li><a href="#00">REGEX avancées</a></li>
<li><a href="#00">Allez plus loin avec les sous-requêtes</a></li>
<li><a href="#00">Les BD Games, 2e édition</a></li>
</ol>
<hr />
<h1 id="coder-avec-mysql">Coder avec MySQL</h1>
<ul>
<li>Déclaration de variables</li>
<li>Instruction conditionnelles</li>
<li>Boucles</li>
<li>Déclaration de fonctions</li>
</ul>
<hr />
<h1 id="variables">Variables</h1>
<p>On retrouve 2 types de variables en MySQL :
- Variables globales 
- Variables locales</p>
<p>Les variables globales sont accessibles partout, mais elles doivent être redéclarer à chaque exécution.</p>
<p>Lorsqu'on peut utiliser une variable locale, <strong>on le fait !</strong>.</p>
<hr />
<h1 id="variables-globales">Variables globales</h1>
<p>Pour déclarer ou modifier une variable globale on utilise l’instruction</p>
<pre><code class="language-sql">SET @variable = valeur
</code></pre>
<p>Les valeurs possibles dans une variables sont :
Integer, decimal, float, blob, text</p>
<p>Toute autre type est converti dans un de ces types.</p>
<hr />
<h1 id="afficher-une-variable">Afficher une variable</h1>
<p>On utilise l’instruction SELECT pour afficher une variable.</p>
<pre><code class="language-sql">SET @nombre = 12;
SELECT @nombre;
</code></pre>
<p>Le résultat est :</p>
<pre><code>| @nombre |
-----------
| 12      |
</code></pre>
<hr />
<h1 id="variables-locales">Variables locales</h1>
<p>Elles doivent être utilisées dans un bloc <strong>BEGIN ... END</strong></p>
<pre><code class="language-sql">DECLARE nom TYPE DEFAULT valeur;
</code></pre>
<p>Par exemple</p>
<pre><code class="language-sql">DECLARE _nombre INTEGER DEFAULT 12;
</code></pre>
<p>Le <strong>DEFAULT</strong> valeur peut être omis pour ne pas affecter de valeurs lors de la déclaration. On les modifie également en utilisant l’instruction <strong>SET</strong> ou un <strong>SELECT</strong>.</p>
<hr />
<h1 id="variables-locales_1">Variables locales</h1>
<p>Toutes les instructions <strong>DECLARE</strong> doivent être au début du bloc <strong>BEGIN</strong>.</p>
<p><strong>Pour reconnaître les variables locales des colonnes, toutes les variables locales doivent être préfixées de  (standard de code)</strong></p>
<hr />
<h1 id="operations">Opérations</h1>
<p>Les opérations arithmétiques et de comparaison sont permises dans les membres de droite des assignations.</p>
<p>On peut également utiliser les variables dans les requêtes.</p>
<pre><code class="language-sql">SELECT nom FROM Etudiant 
  WHERE code_etudiant = @code;
</code></pre>
<hr />
<h1 id="instruction-conditionnelle">Instruction conditionnelle</h1>
<p>L’instruction conditionnelle de base à la syntaxe suivante</p>
<pre><code class="language-sql">IF condition THEN
    traitements…
END IF;
</code></pre>
<p>Pas d’accolade { }, elles sont remplacées par THEN … END IF;</p>
<p>Par exemple, on vérifie que l'âge est plus grande ou égale à 18 (le code ne fonctionne pas, on ne peut pas mettre d'instructions conditionnelles hors d'une fonction en SQL).</p>
<pre><code class="language-sql">IF @age &gt;= 18 THEN
  SELECT 'Vous etes majeur';
END IF;
</code></pre>
<hr />
<h1 id="traitements-alternatifs">Traitements alternatifs</h1>
<pre><code class="language-sql">IF condition THEN
    traitement
ELSEIF condition alternative THEN
    traitement
ELSE
    traitement
END IF;
</code></pre>
<hr />
<h1 id="instruction-par-cas">Instruction par cas</h1>
<p>Semblable à l’instruction <em>switch</em></p>
<pre><code class="language-sql">CASE 
  WHEN condition THEN traitement
  WHEN condition THEN traitement
  ELSE traitement
END
</code></pre>
<p>La première condition validée est exécutée, puis le CASE est conclut (pas de <em>break</em> et pas de possibilité d'effectuer plusieurs traitements).</p>
<hr />
<h1 id="exemple-de-case">Exemple de CASE</h1>
<p>L'exemple est un peu avancé, retenez l'élément suivant : on peut utiliser le CASE directement dans un SELECT</p>
<pre><code class="language-sql">SELECT      
  CASE 
    WHEN nb_echecs = 0 THEN 'Pas d'echec'
    WHEN nb_echecs &lt;= 2 THEN '2 echecs ou moins'
    ELSE ' Plus de deux echecs' 
  END
  FROM ...          

</code></pre>
<hr />
<h1 id="instructions-repetees">Instructions répétées</h1>
<p>Boucle while qui exécute un traitement tant que la condition est vérifiée.</p>
<pre><code class="language-sql">WHILE condition DO
    traitements…
END WHILE;
</code></pre>
<hr />
<h1 id="instructions-repetees_1">Instructions répétées</h1>
<p>Boucle qui effectue au moins une fois le traitement.</p>
<pre><code class="language-sql">REPEAT 
    traitements…
UNTIL condition
END REPEAT;
</code></pre>
<p>Semblable à la boucle do-while.</p>
<hr />
<h1 id="declarer-une-fonction">Déclarer une fonction</h1>
<p>Qu'est-ce qu'une fonction ?
* Traitement regroupé dans une structure. Peut accepter des valeurs et les transformer pour retourner un résultat.</p>
<p>Particularité en SQL :
* Le type de retour <strong>VOID</strong> n'existe pas. Toutes les fonctions retournent un résultat.</p>
<hr />
<h1 id="types-de-fonction">Types de fonction</h1>
<p>Plusieurs types de caractéristiques de fonctions existent dans MySQL. On en distingue principalement 2 :
- Caractère déterministe
- Contenu de la fonction (Type de requête qu'elle contient)</p>
<hr />
<h1 id="caractere-deterministe">Caractère déterministe</h1>
<p>Indique si la valeur de retour est déterminée seulement selon les paramètres ou non.</p>
<p>2 valeurs possibles :
- DETERMINISTIC
- NOT DETERMINISTIC (NOW, RAND...)</p>
<hr />
<h1 id="contenu_1">Contenu</h1>
<p>4 valeurs représentent le contenu d’une fonction :</p>
<p><strong>NO SQL</strong> : ne contient pas d’instruction SQL
<strong>CONTAINS SQL</strong> : contient des instructions SQL
<strong>READS SQL DATA</strong> : contient une opération SELECT
<strong>MODIFIES SQL DATA</strong> : contient une opération <em>INSERT</em>, <em>UPDATE</em> ou <em>DELETE</em></p>
<p>On indique toujours une seule caractéristique de contenu. (<em>MODIFIES</em> implique <em>READS</em>). </p>
<hr />
<h1 id="exigence-minimale">Exigence minimale</h1>
<p>Dans vos fonctions, vous devez préciser explicitement au moins une caractéristique de déterministe ou de contenu.</p>
<p><strong>Pour le cours, il faut préciser les deux caractéristiques en tout temps</strong></p>
<p><em>Par défaut</em> :
Déterminisme : <strong>NOT DETERMINISTIC</strong>
Valeur : <strong>CONTAINS SQL</strong></p>
<p>Vous pouvez en préciser une de chaque type.</p>
<hr />
<h1 id="cas-des-fonctions-non-deterministe">Cas des fonctions non déterministe</h1>
<p><em>ERREUR 1418</em> : This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you <em>might</em> want to use the less safe log_bin_trust_function_creators variable).</p>
<p>Pour éviter cette erreur, on peut exécuter la ligne suivante AVANT de créer la fonction :</p>
<pre><code class="language-sql">SET GLOBAL log_bin_trust_function_creators = 1;
</code></pre>
<p>Référence : https://stackoverflow.com/questions/26015160/deterministic-no-sql-or-reads-sql-data-in-its-declaration-and-binary-logging-i</p>
<hr />
<h1 id="declarer-une-fonction_1">Déclarer une fonction</h1>
<pre><code class="language-sql">DELIMITER $$

CREATE FUNCTION nom_fonction() RETURNS TYPE CARACTERISTIQUE_1 CARACTERISTIQUE_2
BEGIN   
  ...
  RETURN VALEUR;
END $$

DELIMITER ;
</code></pre>
<hr />
<h1 id="exemple-de-fonction">Exemple de fonction</h1>
<p>Fonction qui retourne le nombre d’enregistrements de la table Étudiant.</p>
<pre><code class="language-sql">DELIMITER $$

CREATE FUNCTION nombre_etudiants() RETURNS INTEGER NOT DETERMINISTIC READS SQL DATA
BEGIN       
  DECLARE _nombre INT;    
  SET _nombre = (SELECT count(*) FROM Etudiant);    
  RETURN _nombre;
END $$

DELIMITER ;
</code></pre>
<p>Pour exécuter la fonction</p>
<pre><code class="language-sql">SELECT nombre_etudiants();
</code></pre>
<hr />
<h1 id="ajoutez-des-parametres">Ajoutez des paramètres</h1>
<p>On précise les paramètres entre les parenthèses en utilisant la syntaxe </p>
<pre><code>nom_parametre TYPE
</code></pre>
<hr />
<h1 id="exemple-de-fonction_1">Exemple de fonction</h1>
<p>La fonction ajoute 1 à son argument.</p>
<pre><code class="language-sql">DELIMITER $$

CREATE FUNCTION plus_un(_nombre INTEGER) RETURNS INTEGER DETERMINISTIC CONTAINS SQL
BEGIN       
  RETURN _nombre + 1;
END $$

DELIMITER ;
</code></pre>
<hr />
<h1 id="supprimer-une-fonction">Supprimer une fonction</h1>
<p>L’instruction pour retirer une fonction est :</p>
<pre><code class="language-mysql">DROP FUNCTION nom_fonction;
</code></pre>
<hr />
<h1 id="documenter-une-fonction">Documenter une fonction</h1>
<p>Pour documenter une fonction, on utilise un commentaire de style JavaDOC</p>
<pre><code>/**
 * Description de la fonction
 *
 * @param _nom_parametre Description
 * @param _nom_parametre Description
 * @return Description de la valeur retournée
 */
</code></pre>
<hr />
<h1 id="exercice-5-1">Exercice 5-1</h1>
<p>A. Faites la somme de deux entiers et retournez le résultat.
B. Calculer la factorielle d’un entier.
 Rappel :
    6! = 6 x 5 x 4 x 3 x 2 x 1 x 1
  0! = 1</p>
<p>Suite page suivante</p>
<hr />
<h1 id="exercice-5-1_1">Exercice 5-1</h1>
<p>C. Retournez le nombre d’étudiants inscrit dans un groupe dont vous connaissez la session (semestre et annee), le cours (sigle) et le numéro du groupe. Effectuez cet exerice de deux façons : sans utiliser de jointure et en utilisant des jointures.
<strong>Paramètres</strong> : semestre, annee, sigle, numero_groupe </p>
<h3 id="exemples-dexecution">Exemples d'exécution</h3>
<table>
<thead>
<tr>
<th>Semestre</th>
<th>Annee</th>
<th>Sigle</th>
<th>Numéro de groupe</th>
<th>Nombre d'étudiants</th>
</tr>
</thead>
<tbody>
<tr>
<td>Automne</td>
<td>2020</td>
<td>420-1D6-VI</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>Automne</td>
<td>2021</td>
<td>420-1D6-VI</td>
<td>1</td>
<td>2</td>
</tr>
</tbody>
</table>
<hr />
<h1 id="declencheur">Déclencheur</h1>
<ul>
<li>Syntaxe</li>
<li>Exercices</li>
<li>Combinaison avec fonction</li>
<li>Exercice</li>
</ul>
<hr />
<h1 id="declencheurs">Déclencheurs</h1>
<p>Comment résoudre les situations suivantes :</p>
<ul>
<li>Si l’on essaie d’ajouter une note plus grande que la note maximale d’évaluation, alors on affecte la note maximale</li>
<li>Après la création d'une Evaluation, on crée un ligne de EvaluationEtudiant pour chaque étudiant du groupe</li>
<li>Si l'on supprime une EvaluationEtudiant, alors on supprime le document associé (sens inverse du ON CASCADE) </li>
</ul>
<hr />
<h1 id="declencheurs_1">Déclencheurs</h1>
<p>Un déclencheur (appelé communément <em>Trigger</em>) permet d’effectuer un traitement immédiatement avant ou après une opération :</p>
<ul>
<li>INSERT </li>
<li>UPDATE</li>
<li>DELETE</li>
</ul>
<hr />
<h1 id="syntaxe-des-declencheurs">Syntaxe des déclencheurs</h1>
<pre><code class="language-sql">DELIMITER $$
CREATE TRIGGER nom TEMPS EVENEMENT ON Table FOR EACH ROW
BEGIN
    traitement
END; $$
DELIMITER ;

TEMPS : BEFORE ou AFTER
EVENEMENT : INSERT, UPDATE ou DELETE
</code></pre>
<hr />
<h1 id="choisir-before-ou-after">Choisir BEFORE ou AFTER</h1>
<p><strong>BEFORE</strong> :
Quand il faut changer une valeur à insérer ou à modifier.</p>
<p><strong>AFTER</strong> :
Quand on veut s’assurer que la donnée soit bien insérée avant de faire le traitement (ex. n’a pas déclenché un check erroné). </p>
<hr />
<h1 id="acceder-a-lenregistrement-modifie">Accéder à l'enregistrement modifié</h1>
<p>On peut utiliser les références <strong>OLD</strong> et <strong>NEW</strong> pour accéder à l'enregistrement qui fait l'objet d'un déclencheur.</p>
<table>
<thead>
<tr>
<th>Type de requête</th>
<th>OLD</th>
<th>NEW</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSERT</td>
<td>NULL</td>
<td>L'enregistrement inséré</td>
</tr>
<tr>
<td>UPDATE</td>
<td>L'enregistrement avant la modification</td>
<td>L'enregistrement après la modification</td>
</tr>
<tr>
<td>DELETE</td>
<td>L'enregistrement supprimé</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<hr />
<h1 id="exemple">Exemple</h1>
<p>Si l’on essaie d’ajouter une note plus grande que la note maximale d’évaluation, alors on affecte la note maximale</p>
<pre><code class="language-sql">DELIMITER $$
CREATE TRIGGER respect_note_maximale BEFORE INSERT ON Evaluation_etudiant FOR EACH ROW
BEGIN
  DECLARE _note_maximale INTEGER;
  SET _note_maximale = (
    SELECT ponderation FROM Evaluation 
      WHERE id_evaluation = NEW.id_evaluation
  );

  IF NEW.note &gt; _note_maximale THEN
    SET NEW.note = _note_maximale;
  END IF;
END $$

DELIMITER ;
</code></pre>
<hr />
<h1 id="documenter-un-declencheur">Documenter un déclencheur</h1>
<p>Pour documenter un déclencheur, on utilise un commentaire de style JavaDOC</p>
<pre><code>/**
 * Description du TRIGGER
 *
 * @dependencies Table_dependante, table_dependante...
 */
</code></pre>
<hr />
<h1 id="demonstration">Démonstration</h1>
<p>Si la date de passation d'une nouvelle évaluation est hors de la durée de la session, alors on lui affecte la valeur nulle.</p>
<hr />
<h1 id="exercice-5-2">Exercice 5-2</h1>
<p>Ajoutez les déclencheurs permettant d'effectuer les traitements suivants</p>
<p>A. Lorsqu'on supprime un enseignant, tous les programmes dont il est responsable sont modifiés pour que le responsable soit NULL (enlever la contrainte NOT NULL sur la colonne responsable)
B. À la suppression d'une EvaluationEtudiant, alors on supprime le document associé (sens inverse du ON CASCADE) </p>
<hr />
<h1 id="conflits-et-limitations-des-declencheurs-et-des-fonctions">Conflits et limitations des déclencheurs et des fonctions</h1>
<p>Les cas de figure suivant sont interdits :
- Une fonction ne peut pas s'appeler elle-même
- Un déclencheur ne peut pas être appelé sur une table en modification par un déclencheur</p>
<p>Un déclencheur peut appeler une fonction et l'exécution d'une fonction pourrait activer un déclencheur.</p>
<p><strong>Les appels implicits sont aussi interdits !</strong></p>
<hr />
<h1 id="exemple-de-schemas-dexecution-a-probleme">Exemple de schémas d'exécution à problème</h1>
<p><img alt="" src="../images/5_fct_trigger.png" /></p>
<hr />
<h1 id="declencheurs-sur-la-meme-table">Déclencheurs sur la même table</h1>
<p>Appeler un déclencheur BEFORE et un AFTER sur la même table.</p>
<ol>
<li>La table est verrouillée, le déclencheur BEFORE s'exécute, la table est libérée</li>
<li>La requête s'exécute</li>
<li>La table est verrouillée, le déclencheur AFTER s'exécute, la table est libérée</li>
</ol>
<p>Donc une table peut définir jusqu'à 6 déclencheurs.</p>
<hr />
<h1 id="demonstration_1">Démonstration</h1>
<p>Si la date de passation d'une évaluation est hors de la durée de la session, alors on lui affecte la valeur nulle.</p>
<p>Gérez cette validation pour l'insertion et la modification.</p>
<hr />
<h1 id="exercice-5-3">Exercice 5-3</h1>
<p>C. Si l'évaluation ajoutée cause la somme des pondérations du cours à excéder 100%, alors la pondération devient 0. Gérez cette validation lors de l'ajout et de la modification.</p>
<hr />
<h1 id="lire-la-documentation">Lire la documentation</h1>
<p><center></p>
<table>
<thead>
<tr>
<th style="text-align: center;">Symbole</th>
<th>Signification</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">[ ]</td>
<td>Indique un élément optionnel</td>
</tr>
<tr>
<td style="text-align: center;">…</td>
<td>Ellipse (permet de répéter un élément)</td>
</tr>
<tr>
<td style="text-align: center;">MAJUSCULES</td>
<td>Mot-clé du langage</td>
</tr>
<tr>
<td style="text-align: center;">Italique</td>
<td>Terme définit plus loin</td>
</tr>
<tr>
<td style="text-align: center;">|</td>
<td>OU</td>
</tr>
<tr>
<td style="text-align: center;">{ }</td>
<td>Un dans la liste est obligatoire</td>
</tr>
</tbody>
</table>
<p></center></p>
<p><strong>Le texte contient des informations importantes sur ce qui est permis et le résultat des opérations.</strong></p>
<hr />
<h1 id="procedures-stockees">Procédures stockées</h1>
<ul>
<li>Syntaxe</li>
<li>Exercices</li>
<li>Gestion des erreurs et des transactions</li>
<li>Exercices</li>
</ul>
<hr />
<h1 id="procedures-stockees_1">Procédures stockées</h1>
<p>Les procédures stockées sont semblables aux fonctions. Elles permettent de préparer des traitements (comme des fonctions) et de les exécuter. À la différence des fonctions les procédures stockées :</p>
<ul>
<li>Peuvent ne pas retourner de valeur</li>
<li>Peuvent s'appeller elle-même</li>
<li>Les fonctions ne peuvent pas appeler de procédures, mais les procédures peuvent appeler des fonctions</li>
</ul>
<hr />
<h1 id="utilisation-des-procedures-et-des-fonctions">Utilisation des procédures et des fonctions</h1>
<p>Les procédures gèrent généralement la logique applicative (couche métier). Par exemple, les ajouts ou modifications aux données.</p>
<p>Les fonctions définissent généralement un traitement d’appoint, un calcul ou l'obtention d'un renseignement.</p>
<hr />
<h1 id="declarer-et-invoquer-une-procedure">Déclarer et invoquer une procédure</h1>
<pre><code class="language-sql">DELIMITER $$

CREATE PROCEDURE nom_procedure()
BEGIN
  traitement
END $$

DELIMITER ;

</code></pre>
<p>Pour invoquer une procédure, on utilise l'instruction <strong>CALL</strong>.</p>
<pre><code class="language-sql">CALL nom_procedure();
</code></pre>
<hr />
<h1 id="parametres-de-procedure">Paramètres de procédure</h1>
<p>Les paramètres d'une procédure peuvent prendre 3 formes :</p>
<ul>
<li>IN : paramètre d'entrée, donc en lecture seule</li>
<li>OUT : paramètre de sortie, donc en écriture puis en lecture au besoin</li>
<li>INOUT : paramètre d'entrée et de sortie (ref). En lecture et en écriture.</li>
</ul>
<p>On inscrit des variables dans les paramètres OUT pour récupérer les valeurs. Si la variable contient déjà une valeur, il n'est pas possible de la récupérer dans la procédure.</p>
<hr />
<h1 id="exemple_1">Exemple</h1>
<pre><code class="language-sql">DELIMITER $$
CREATE PROCEDURE somme (IN _operande1 INT, IN _operande2 INT, OUT _resultat INT)
BEGIN   
  SET _resultat = _operande1 + _operande2;
END $$
DELIMITER ; 
</code></pre>
<p>On remarque ici :
- L'absence d'instruction RETURN (interdit dans une procédure)
- L'utilisation du OUT pour résultat</p>
<hr />
<h1 id="invocation-de-procedure">Invocation de procédure</h1>
<pre><code class="language-sql">SET @resultat = 0;            -- Déclaration d'une variable
CALL somme(2, 4, @resultat);  -- Invocation
SELECT @resultat;             -- Affichage
</code></pre>
<hr />
<h1 id="documenter-une-procedure">Documenter une procédure</h1>
<p>Chaque procédure s'accompagne d'une documentation d'en-tête</p>
<pre><code class="language-sql">/**
 * Description de la procédure
 * 
 * @param   IN | OUT | INOUT  Nom du paramètre  Description   
 * @param   IN | OUT | INOUT  Nom du paramètre  Description  
 * ...
 */
</code></pre>
<p><strong>Comme les procédures peuvent devenir très longues, il est important d'utiliser des commentaires pour les variables locales déclarées et certaines instructions (IF, WHILE, REPEAT ...)</strong></p>
<hr />
<h1 id="exercice-5-4">Exercice 5-4</h1>
<p>A. Créez une procédure pour ajouter un nouveau groupe. Initialement l'enseignant est null. Vous connaissez seulement le semestre, l'année et le sigle du cours. Vous devez ajouter le numéro de groupe suivant (si le groupe 1 et 2 existent, alors le groupe aura le numéro 3). Le premier groupe porte le numéro 1. La procédure retourne le numéro du groupe qui a été créé. En cas d'erreur, le numéro -1 est retourné.</p>
<p><strong>Paramètres</strong> : semestre, annee et sigle du cours
<strong>Valeur de retour</strong> : le numéro du groupe qui a été créé</p>
<hr />
<p>B. Créez une procédure pour inscrire un étudiant à un cours. La procédure reçoit le code de l'étudiant, le sigle du cours, le semestre et l'année pour l'inscription. </p>
<p>L'étudiant est toujours ajouté au groupe avec le plus petit numéro qui a une place de libre. Si le groupe est plein (4 étudiants et plus), alors un nouveau groupe est créé.</p>
<p>Le numéro du groupe dans lequel l'élève a été inscrit est retourné. En cas d'erreur, la valeur -1 est retournée.</p>
<p><strong>Paramètres</strong> : code étudiant, sigle du cours, semestre, année
<strong>Valeur de retour</strong> : numéro du groupe dans lequel l'inscription s'est faite</p>
<hr />
<h1 id="transactions-et-gestion-derreur">Transactions et gestion d'erreur</h1>
<p>Concept d'exception en programmation
Principe d’une transaction</p>
<hr />
<h1 id="exceptions-en-programmation">Exceptions en programmation</h1>
<p><center></p>
<p><img alt="" src="../images/5_exception.png" /></p>
<p></center></p>
<hr />
<h1 id="quand-gerer-les-exceptions">Quand gérer les exceptions</h1>
<ul>
<li>Quand une erreur de fonctionnement imprévisible est à risque de survenir :</li>
<li>Donnée utilisateur</li>
<li>Référence à un programme externe</li>
<li>Référence à des données non contrôlées</li>
<li>Gérer certaines scénarios d'exécution problématiques</li>
</ul>
<hr />
<h1 id="exceptions-possibles-en-bd">Exceptions possibles en BD</h1>
<p>Les exceptions possibles dans le domaine de la BD sont :</p>
<ul>
<li>Violation de contrainte</li>
<li>Duplicat de clé primaire</li>
<li>Duplicat de valeur unique</li>
<li>Insérer NULL dans une colonne qui n'est pas nullifiable</li>
<li>Ne pas respecter un contrainte CHECK</li>
<li>Ne pas respecter une clé étrangère </li>
<li>Exception personnalisées</li>
</ul>
<hr />
<h1 id="codes-derreur-mysql">Codes d'erreur MySQL</h1>
<p>Les codes d'erreur de MySQL sont gérés par les <strong>SQLSTATE</strong>. Les états SQL sont des codes à 5 chiffres. Les 2 premiers indiquent un état global (erreur, avertissement, succès, information...) et les 3 derniers sont spécifiques à la situation</p>
<ul>
<li>00### : indique un succès</li>
<li>01### : avertissement</li>
<li>02### : non trouvé</li>
<li>&gt;02### : exception</li>
</ul>
<hr />
<h1 id="lancer-un-signal">Lancer un signal</h1>
<p>Le SGBD lance des sigaux lorsqu'une erreur interne se produit. Il est possible de lancer un signal avec un code d'erreur personnalisé.</p>
<pre><code class="language-sql">SIGNAL SQLSTATE 'code 5 chiffres' SET MESSAGE_TEXT = 'Message erreur';
</code></pre>
<hr />
<h1 id="gestion-des-signaux-et-des-transactions">Gestion des signaux et des transactions</h1>
<p>Pour attraper un signal, on déclare un gestionnaire (<em>handler</em>).</p>
<pre><code class="language-mysql">DECLARE action HANDLER FOR condition | code
</code></pre>
<p>L'action est de deux types :
- CONTINUE : le bloc BEGIN - END continue son exécution après la gestion du signal
- EXIT : le bloc BEGIN - END arrête son exécution après la gestion du signal.</p>
<p>Les gestionnaires peuvent seulement être déclarés dans les procédures.</p>
<hr />
<h1 id="condition-du-gestionnaire">Condition du gestionnaire</h1>
<p>La condition peut être de différents types.
- Une classe de signaux :
  - SQLWARNING
  - NOT FOUND 
  - SQLEXCEPTION
- Un code particulier :
  - Code d'erreur MySQL (4 chiffres) : https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html
  - Un code de signal SQLSIGNAL code5
- Le nom d'une condition (<strong>DECLARE ... CONDITION</strong>)</p>
<hr />
<h1 id="exemple_2">Exemple</h1>
<p>Attraper les erreurs de clé primaire nulle</p>
<pre><code class="language-mysql">DECLARE EXIT HANDLER FOR 1171 

-- Alternative

DECLARE EXIT HANDLER FOR 42000
</code></pre>
<p>Attraper toutes les exceptions</p>
<pre><code class="language-mysql">DECLARE EXIT HANDLER FOR SQLEXCEPTION
</code></pre>
<hr />
<h1 id="afficher-lerreur">Afficher l'erreur</h1>
<p>On récupère l'erreur avec une requête </p>
<pre><code class="language-sql">GET DIAGNOSTICS 
</code></pre>
<p>Par exemple pour récupérer le code et le message d'erreur actuel</p>
<pre><code class="language-sql">GET DIAGNOSTICS CONDITION 1            
  _code = RETURNED_SQLSTATE, 
  _message = MESSAGE_TEXT;
SELECT _code, _message;
</code></pre>
<p>où _code et _message sont des variables locales</p>
<hr />
<h1 id="exemple-complet-de-gestion-dexception">Exemple complet de gestion d'exception</h1>
<pre><code class="language-sql">CREATE PROCEDURE gestion_erreur()
BEGIN
  DECLARE _code CHAR(5);
  DECLARE _message TEXT;
  ...

  -- On répère ce bloc pour chaque type d'erreur à traiter
  DECLARE EXIT HANDLER FOR 00000
  BEGIN
    GET DIAGNOSTICS CONDITION 1
      _code = RETURNED_SQLSTATE,
      _message = MESSAGE_TEXT;
    SELECT _code, _message;
  END;

  ...
</code></pre>
<hr />
<h1 id="transactions-mise-en-situation">Transactions - Mise en situation</h1>
<p>Timmy, dévoué programmeur, crée un script qui importe, dans notre système École, les notes de tous les étudiants à une évaluation . Afin d'éviter d'insérer de mauvaises données, Timmy applique la règle suivante : si une des notes ne peut pas être ajoutée (par exemple pour une violation de contrainte), alors aucune note n'est ajoutée.</p>
<p>Si notre script s’exécute automatiquement, comment appliquer cette mesure ?</p>
<hr />
<h1 id="principe-dune-transaction">Principe d’une transaction</h1>
<p>Une transaction contient une série d’instructions. Une fois que toutes les instructions ont été effectuées, on peut les enregistrer ou les annuler.</p>
<p>L’utilisation de transaction facilite l’exécution d’instructions multiples et aide à maintenir une intégrité dans nos données.</p>
<hr />
<h1 id="fonctionnement-dune-transaction">Fonctionnement d'une transaction</h1>
<ol>
<li>On commence pas indiquer notre intention de faire un bloc d'instructions (transaction) par START TRANSACTION</li>
<li>On effectue les requêtes</li>
<li>On COMMIT la transaction si tout s'est bien déroulé OU on ROLLBACK si on veut tout annuler.</li>
</ol>
<hr />
<h1 id="exemple_3">Exemple</h1>
<p>Ajoutez la contrainte suivante à la table Evaluation_etudiant </p>
<pre><code class="language-mysql">CONSTRAINT interval_note CHECK (note BETWEEN 0 AND 100)
</code></pre>
<p>Désactivons le autocommit de MySQL Workbench</p>
<p><center></p>
<p><img alt="" src="../images/4_autocommit.png" /></p>
<p></center></p>
<hr />
<h1 id="exemple_4">Exemple</h1>
<p>Ajoutons les données suivantes</p>
<pre><code class="language-mysql">INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 1234567, 22, NULL);

INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 4567890, -5, NULL);


INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 8901234, 24, NULL);
</code></pre>
<p>Comment revenir supprimer le premier enregistrement qui s'est bien déroulé ?</p>
<hr />
<h1 id="exemple-de-rollback">Exemple de ROLLBACK</h1>
<pre><code class="language-mysql">SELECT count(id_evaluation) FROM Evaluation_etudiant; -- Affiche 75


START TRANSACTION;


INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 1234567, 22, NULL);

INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 4567890, -5, NULL);


INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 8901234, 24, NULL);


SELECT count(id_evaluation) FROM Evaluation_etudiant; -- Affiche 77 (+2)


ROLLBACK; -- Il y a eu erreur


SELECT count(id_evaluation) FROM Evaluation_etudiant; -- Affiche 75
</code></pre>
<hr />
<h1 id="exemple-de-commit">Exemple de commit</h1>
<p>Les INSERT sont valides cette fois-ci.</p>
<pre><code class="language-mysql">SELECT count(id_evaluation) FROM Evaluation_etudiant; -- Affiche 75


START TRANSACTION;


INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 1234567, 22, NULL);

INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 4567890, 17, NULL);


INSERT INTO Evaluation_etudiant (id_evaluation, etudiant, note, document) VALUES
  (1, 8901234, 24, NULL);


SELECT count(id_evaluation) FROM Evaluation_etudiant; -- Affiche 78 (+3)


COMMIT; -- Tout s'est bien déroulé


SELECT count(id_evaluation) FROM Evaluation_etudiant; -- Affiche 78
</code></pre>
<hr />
<h1 id="demonstration_2">Démonstration</h1>
<p>Créez une procédure pour inscire un nouveau vol. La procédure reçoit une immatriculation de viasseau, le numéro de vol et le nom du capitaine du vol.</p>
<p>La procédure crée le vol et ajoute un membre d'équipage, le capitaine. En cas d'erreur, aucune donnée ne doit être créée.</p>
<hr />
<h1 id="exercice-5-5">Exercice 5-5</h1>
<p>A. Créez une procédure pour noter un étudiant. Cette procédure doit accepter un code étudiant, l'id de groupe (que l'on suppose avoir obtenu par un autre moyen) et le nom de l'évaluation. </p>
<p>Supposez que l'id du groupe et le nom de l'évaluation forme une clé unique.</p>
<p>Gérez l'erreur qui pourrait survenir si l'évaluation n'existe pas. </p>
<p>Votre procédure doit permettre d'assigner une note que Evaluation_etudiant existe ou non au préalable.</p>
<p><strong>Paramètres</strong> : code_etudiant, id_groupe, nom_evaluation et note.</p>
<p><em>Suite diapositive suivante</em></p>
<hr />
<p>B. Créez une procédure pour permettre à un étudiant de déposer un travail. La procédure doit accepter un code etudiant, un id_evaluation (que l'on suppose avoir obtenu par un autre moyen) et les informations relative au document. On suppose que Evaluation_etudiant a déjà été créé pour l'évaluation et l'étudiant donné. </p>
<p>Si un document a déjà été déposé, alors :
- Mettez à jour l'information du document
- Déclencher un avertissement de code 01001 qui ne bloque pas l'exécution de la procédure</p>
<p><strong>Paramètres</strong> : code_etudiant, id_evaluation et le titre du document</p>
<p><em>Suite diapositive suivante</em></p>
<hr />
<p>C. Vous devez ajouter 3 nouveaux enseignants dans le système École. Voici les données de ceux-ci.</p>
<p>Effectuez l'opération en utilisant les transactions. Si l'un d'entre eux ne peut pas être ajouté, alors aucune ne doit l'être.</p>
<table>
<thead>
<tr>
<th>Code employé</th>
<th>Nom</th>
<th>No assurance sociale</th>
<th>Ancienneté</th>
</tr>
</thead>
<tbody>
<tr>
<td>7645</td>
<td>Diana de Themyscira</td>
<td>111 222 333</td>
<td>15</td>
</tr>
<tr>
<td>7654</td>
<td>Jason Todd</td>
<td>987 654 321</td>
<td>1</td>
</tr>
<tr>
<td>6574</td>
<td>Barry Allen</td>
<td>555 777 333</td>
<td>8</td>
</tr>
</tbody>
</table>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Retour en haut de la page
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>